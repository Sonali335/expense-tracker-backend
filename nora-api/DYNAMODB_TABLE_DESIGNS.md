# DynamoDB Table Designs for Nora API

This document provides detailed table designs for all DynamoDB tables used in the Nora API.

## Table Overview

All tables use **Pay-Per-Request** billing mode and have `id` (String) as the **Partition Key**.

---

## 1. Users Table

**Table Name**: `nora-users` (configurable via `DYNAMODB_TABLE_USERS`)

### Key Schema
- **Partition Key**: `id` (String)

### Attributes
| Attribute | Type | Description | Required |
|-----------|------|-------------|----------|
| `id` | String | Unique identifier (generated by `generateId()`) | Yes |
| `username` | String | Unique username for login | Yes |
| `password` | String | Hashed password (bcrypt) | Yes |

### Sample Item
```json
{
  "id": "1737567890123abc456def",
  "username": "john_doe",
  "password": "$2b$10$abcdefghijklmnopqrstuvwxyz1234567890"
}
```

### AWS CLI Create Command
```bash
aws dynamodb create-table \
  --table-name nora-users \
  --attribute-definitions AttributeName=id,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region us-east-1
```

### Access Patterns
- **Get user by ID**: Direct GetItem using `id`
- **Get user by username**: Scan with FilterExpression on `username`
- **Create user**: PutItem with generated `id`

---

## 2. Contacts Table

**Table Name**: `nora-contacts` (configurable via `DYNAMODB_TABLE_CONTACTS`)

### Key Schema
- **Partition Key**: `id` (String)

### Attributes
| Attribute | Type | Description | Required |
|-----------|------|-------------|----------|
| `id` | String | Unique identifier (generated by `generateId()`) | Yes |
| `full_name` | String | Full name of the contact | Yes |
| `email` | String | Email address | Yes |
| `company_name` | String | Company name | No |
| `category` | String | Contact category (e.g., "customer_vendor") | No |
| `language` | String | Preferred language | No |
| `currency` | String | Preferred currency (e.g., "CAD") | No |
| `created_at` | String | ISO 8601 timestamp | Yes (auto-generated) |

### Sample Item
```json
{
  "id": "1737567890123xyz789abc",
  "full_name": "Test Contact API",
  "email": "test@example.com",
  "company_name": "Test Corp",
  "category": "customer_vendor",
  "language": "en",
  "currency": "CAD",
  "created_at": "2026-01-21T22:15:00.000Z"
}
```

### AWS CLI Create Command
```bash
aws dynamodb create-table \
  --table-name nora-contacts \
  --attribute-definitions AttributeName=id,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region us-east-1
```

### Access Patterns
- **List all contacts**: Scan operation
- **Get contact by ID**: Direct GetItem using `id`
- **Create contact**: PutItem with generated `id` and `created_at`
- **Update contact**: UpdateItem using `id`
- **Delete contact**: DeleteItem using `id`

---

## 3. Invoices Table

**Table Name**: `nora-invoices` (configurable via `DYNAMODB_TABLE_INVOICES`)

### Key Schema
- **Partition Key**: `id` (String)

### Attributes
| Attribute | Type | Description | Required |
|-----------|------|-------------|----------|
| `id` | String | Unique identifier (generated by `generateId()`) | Yes |
| `contact_id` | String | Reference to contact ID | Yes |
| `number` | String | Invoice number | Yes |
| `date` | String | Invoice date (YYYY-MM-DD) | Yes |
| `due_date` | String | Due date (YYYY-MM-DD) | Yes |
| `currency` | String | Currency code (e.g., "CAD") | Yes |
| `total` | Number | Total amount (calculated from items) | Yes |
| `status` | String | Invoice status (default: "draft", can be "void") | Yes |
| `items` | List | Array of invoice items (embedded) | Yes |

### Invoice Items Structure (within `items` array)
Each item in the `items` array has:
```json
{
  "description": "Consulting Services",
  "quantity": 1,
  "unit_price": 100.00,
  "taxes": ["TPS", "TVP"]
}
```

### Sample Item
```json
{
  "id": "1737567890123inv123456",
  "contact_id": "1737567890123xyz789abc",
  "number": "70",
  "date": "2026-01-21",
  "due_date": "2026-02-20",
  "currency": "CAD",
  "total": 112.00,
  "status": "draft",
  "items": [
    {
      "description": "Consulting Services",
      "quantity": 1,
      "unit_price": 100.00,
      "taxes": ["TPS", "TVP"]
    }
  ]
}
```

### AWS CLI Create Command
```bash
aws dynamodb create-table \
  --table-name nora-invoices \
  --attribute-definitions AttributeName=id,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region us-east-1
```

### Access Patterns
- **List all invoices**: Scan operation
- **Get invoice by ID**: Direct GetItem using `id`
- **Filter by status**: Scan with FilterExpression on `status`
- **Filter by contact_id**: Scan with FilterExpression on `contact_id`
- **Filter by date range**: Scan with FilterExpression on `date` (BETWEEN)
- **Create invoice**: PutItem with generated `id` and calculated `total`
- **Update invoice**: UpdateItem using `id`
- **Delete invoice**: DeleteItem using `id`

### Note on Invoice Items
In DynamoDB, invoice items are stored as an **embedded array** within the invoice document (NoSQL pattern). This differs from SQLite where items were in a separate `invoice_items` table. This design:
- Simplifies queries (no JOINs needed)
- Ensures atomic operations (invoice and items are always consistent)
- Reduces read/write operations

---

## 4. Expenses Table

**Table Name**: `nora-expenses` (configurable via `DYNAMODB_TABLE_EXPENSES`)

### Key Schema
- **Partition Key**: `id` (String)

### Attributes
| Attribute | Type | Description | Required |
|-----------|------|-------------|----------|
| `id` | String | Unique identifier (generated by `generateId()`) | Yes |
| `date` | String | Expense date (YYYY-MM-DD) | Yes |
| `category_id` | Number | Category identifier | No |
| `vendor_name` | String | Vendor/merchant name | Yes |
| `amount` | Number | Expense amount | Yes |
| `currency` | String | Currency code (e.g., "CAD") | No |
| `tax_amount` | Number | Tax amount | No |
| `is_paid` | Number | Payment status (0 = unpaid, 1 = paid) | No |
| `description` | String | Expense description | No |

### Sample Item
```json
{
  "id": "1737567890123exp456789",
  "date": "2026-01-21",
  "category_id": 5,
  "vendor_name": "Amazon",
  "amount": 50.00,
  "currency": "CAD",
  "tax_amount": 6.50,
  "is_paid": 1,
  "description": "Office supplies"
}
```

### AWS CLI Create Command
```bash
aws dynamodb create-table \
  --table-name nora-expenses \
  --attribute-definitions AttributeName=id,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region us-east-1
```

### Access Patterns
- **List all expenses**: Scan operation
- **Get expense by ID**: Direct GetItem using `id`
- **Filter by date range**: Scan with FilterExpression on `date` (BETWEEN)
- **Create expense**: PutItem with generated `id`
- **Update expense**: UpdateItem using `id`

---

## 5. Time Worked Table

**Table Name**: `nora-time-worked` (configurable via `DYNAMODB_TABLE_TIME_WORKED`)

### Key Schema
- **Partition Key**: `id` (String)

### Attributes
| Attribute | Type | Description | Required |
|-----------|------|-------------|----------|
| `id` | String | Unique identifier (generated by `generateId()`) | Yes |
| `contact_id` | String | Reference to contact ID | Yes |
| `date` | String | Date of work (YYYY-MM-DD) | Yes |
| `hours` | Number | Hours worked | Yes |
| `minutes` | Number | Minutes worked | Yes |
| `description` | String | Work description | No |

### Sample Item
```json
{
  "id": "1737567890123time789abc",
  "contact_id": "1737567890123xyz789abc",
  "date": "2026-01-21",
  "hours": 8,
  "minutes": 0,
  "description": "API Documentation Work"
}
```

### AWS CLI Create Command
```bash
aws dynamodb create-table \
  --table-name nora-time-worked \
  --attribute-definitions AttributeName=id,AttributeType=S \
  --key-schema AttributeName=id,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region us-east-1
```

### Access Patterns
- **List all time entries**: Scan operation
- **Get time entry by ID**: Direct GetItem using `id`
- **Filter by contact_id**: Scan with FilterExpression on `contact_id`
- **Filter by date range**: Scan with FilterExpression on `date` (BETWEEN)
- **Create time entry**: PutItem with generated `id`

---

## ID Generation

All tables use the `generateId()` function which creates unique IDs using:
```javascript
function generateId() {
  return Date.now().toString() + Math.random().toString(36).substr(2, 9);
}
```

**Format**: `{timestamp}{random_string}`
- Example: `1737567890123abc456def`

This replaces SQLite's AUTOINCREMENT feature.

---

## Recommended Global Secondary Indexes (GSIs)

For better query performance in production, consider adding these GSIs:

### 1. Contacts Table - Email Index
```bash
aws dynamodb update-table \
  --table-name nora-contacts \
  --attribute-definitions AttributeName=email,AttributeType=S \
  --global-secondary-index-updates \
    "[{
      \"Create\": {
        \"IndexName\": \"email-index\",
        \"KeySchema\": [{\"AttributeName\": \"email\", \"KeyType\": \"HASH\"}],
        \"Projection\": {\"ProjectionType\": \"ALL\"}
      }
    }]"
```

### 2. Invoices Table - Contact ID Index
```bash
aws dynamodb update-table \
  --table-name nora-invoices \
  --attribute-definitions AttributeName=contact_id,AttributeType=S \
  --global-secondary-index-updates \
    "[{
      \"Create\": {
        \"IndexName\": \"contact-id-index\",
        \"KeySchema\": [{\"AttributeName\": \"contact_id\", \"KeyType\": \"HASH\"}],
        \"Projection\": {\"ProjectionType\": \"ALL\"}
      }
    }]"
```

### 3. Invoices Table - Status Index
```bash
aws dynamodb update-table \
  --table-name nora-invoices \
  --attribute-definitions AttributeName=status,AttributeType=S \
  --global-secondary-index-updates \
    "[{
      \"Create\": {
        \"IndexName\": \"status-index\",
        \"KeySchema\": [{\"AttributeName\": \"status\", \"KeyType\": \"HASH\"}],
        \"Projection\": {\"ProjectionType\": \"ALL\"}
      }
    }]"
```

### 4. Expenses Table - Date Index
```bash
aws dynamodb update-table \
  --table-name nora-expenses \
  --attribute-definitions AttributeName=date,AttributeType=S \
  --global-secondary-index-updates \
    "[{
      \"Create\": {
        \"IndexName\": \"date-index\",
        \"KeySchema\": [{\"AttributeName\": \"date\", \"KeyType\": \"HASH\"}],
        \"Projection\": {\"ProjectionType\": \"ALL\"}
      }
    }]"
```

---

## Data Type Mapping

| SQLite Type | DynamoDB Type | Notes |
|-------------|---------------|-------|
| INTEGER | Number | Used for numeric values |
| TEXT | String | Used for text fields |
| REAL | Number | Used for decimal values |
| NULL | null | DynamoDB supports null values |
| AUTOINCREMENT | String (generated) | Uses `generateId()` function |

---

## Table Relationships

DynamoDB is a NoSQL database and doesn't support foreign keys or JOINs. Relationships are maintained through:

1. **Embedded Documents**: Invoice items are stored within the invoice document
2. **Reference IDs**: `contact_id` in invoices and time_worked tables reference contacts
3. **Application-Level Joins**: When needed, fetch related data separately and join in application code

---

## Summary Table

| Table Name | Partition Key | Key Attributes | Embedded Data |
|------------|---------------|----------------|---------------|
| `nora-users` | `id` | username, password | None |
| `nora-contacts` | `id` | full_name, email, company_name, etc. | None |
| `nora-invoices` | `id` | contact_id, number, date, total, status | `items` array |
| `nora-expenses` | `id` | date, vendor_name, amount, etc. | None |
| `nora-time-worked` | `id` | contact_id, date, hours, minutes | None |

---

## Notes

1. **All tables use Pay-Per-Request billing** - No need to specify read/write capacity units
2. **All IDs are strings** - Generated using timestamp + random string
3. **No schema enforcement** - DynamoDB is schema-less, but the application enforces structure
4. **Date fields are strings** - Stored as ISO 8601 format (YYYY-MM-DD or full timestamp)
5. **Boolean values** - Stored as numbers (0/1) for `is_paid` field
6. **Arrays** - Invoice items stored as DynamoDB List type
